name: Auto Notify PWA Users

on:
  push:
    branches:
      - main
      - master

jobs:
  send_notification:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Google Auth & cURL
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Authenticate with Google
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.FCM_SERVICE_ACCOUNT }}
        run: |
          echo "$GOOGLE_CREDENTIALS" > creds.json
          ACCESS_TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://oauth2.googleapis.com/token" \
            --data "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer" \
            --data-urlencode "assertion=$(generate_jwt creds.json)")
          echo "TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: Send Notification
        env:
          TOKEN: ${{ env.TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json; UTF-8" \
            -d '{
              "message": {
                "topic": "allUsers",
                "notification": {
                    "title": "OCJT Updated ðŸ’–",
                    "body": "New changes added. Tap to open!"
                },
                "webpush": {
                  "notification": {
                    "icon": "/icon-192.png"
                  }
                }
              }
            }' \
            "https://fcm.googleapis.com/v1/projects/our-complete-journey-together/messages:send"
